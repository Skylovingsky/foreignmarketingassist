<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‰ç«¯èŠå¤©æµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .result { margin: 10px 0; padding: 10px; border: 1px solid #ccc; border-radius: 5px; }
        .success { background-color: #e8f5e8; border-color: #4CAF50; }
        .error { background-color: #ffeaea; border-color: #f44336; }
        button { padding: 10px 20px; margin: 5px; }
        textarea { width: 100%; height: 60px; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>ğŸ¤– å‰ç«¯èŠå¤©åŠŸèƒ½æµ‹è¯•</h1>
    
    <div>
        <h3>æµ‹è¯•æ¶ˆæ¯:</h3>
        <textarea id="testMessage" placeholder="è¾“å…¥æµ‹è¯•æ¶ˆæ¯...">ä½ å¥½ï¼Œæˆ‘æƒ³äº†è§£ä¸€ä¸‹å¤–è´¸å¼€å‘çš„æœ€ä½³å®è·µ</textarea>
        <br>
        <button onclick="testChatDirectly()">ç›´æ¥æµ‹è¯•API</button>
        <button onclick="testFrontendProxy()">æµ‹è¯•å‰ç«¯ä»£ç†</button>
        <button onclick="testStreamingChat()">æµ‹è¯•æµå¼èŠå¤©</button>
        <button onclick="openRealChatPage()">æ‰“å¼€çœŸå®èŠå¤©é¡µé¢</button>
    </div>
    
    <div id="results"></div>

    <script>
        const BACKEND_URL = 'https://3001-ibr8pve55krqf22np4xrh-6532622b.e2b.dev';
        const FRONTEND_URL = 'https://3000-ibr8pve55krqf22np4xrh-6532622b.e2b.dev';
        
        function addResult(title, content, isSuccess = true) {
            const div = document.createElement('div');
            div.className = `result ${isSuccess ? 'success' : 'error'}`;
            div.innerHTML = `<h4>${title}</h4><div>${content}</div>`;
            document.getElementById('results').appendChild(div);
        }
        
        async function testChatDirectly() {
            try {
                const message = document.getElementById('testMessage').value;
                const response = await fetch(`${BACKEND_URL}/api/agent/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        messages: [{
                            id: crypto.randomUUID(),
                            role: 'user',
                            content: message,
                            timestamp: new Date().toISOString()
                        }],
                        useRag: false,
                        temperature: 0.7,
                        maxTokens: 200
                    })
                });
                
                const data = await response.json();
                addResult('âœ… ç›´æ¥åç«¯APIæµ‹è¯•', `
                    <strong>çŠ¶æ€:</strong> ${response.status} ${response.statusText}<br>
                    <strong>AIå›å¤:</strong> ${data.message.content}<br>
                    <strong>Tokenä½¿ç”¨:</strong> ${data.usage.totalTokens}
                `, true);
            } catch (error) {
                addResult('âŒ ç›´æ¥åç«¯APIæµ‹è¯•å¤±è´¥', `é”™è¯¯: ${error.message}`, false);
            }
        }
        
        async function testFrontendProxy() {
            try {
                const message = document.getElementById('testMessage').value;
                const response = await fetch(`${FRONTEND_URL}/api/agent/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        messages: [{
                            id: crypto.randomUUID(),
                            role: 'user',
                            content: message,
                            timestamp: new Date().toISOString()
                        }],
                        useRag: false,
                        temperature: 0.7,
                        maxTokens: 200
                    })
                });
                
                const data = await response.json();
                addResult('âœ… å‰ç«¯ä»£ç†APIæµ‹è¯•', `
                    <strong>çŠ¶æ€:</strong> ${response.status} ${response.statusText}<br>
                    <strong>AIå›å¤:</strong> ${data.message.content}<br>
                    <strong>Tokenä½¿ç”¨:</strong> ${data.usage.totalTokens}<br>
                    <strong>è¯´æ˜:</strong> å‰ç«¯Next.jsä»£ç†å·¥ä½œæ­£å¸¸ï¼
                `, true);
            } catch (error) {
                addResult('âŒ å‰ç«¯ä»£ç†APIæµ‹è¯•å¤±è´¥', `é”™è¯¯: ${error.message}`, false);
            }
        }
        
        async function testStreamingChat() {
            try {
                const message = document.getElementById('testMessage').value;
                const response = await fetch(`${FRONTEND_URL}/api/agent/chat/stream`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        messages: [{
                            id: crypto.randomUUID(),
                            role: 'user',
                            content: message,
                            timestamp: new Date().toISOString()
                        }],
                        useRag: false,
                        temperature: 0.7,
                        maxTokens: 100
                    })
                });
                
                if (response.body) {
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let fullContent = '';
                    
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        
                        const chunk = decoder.decode(value);
                        const lines = chunk.split('\\n');
                        
                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                const data = line.slice(6);
                                if (data === '[DONE]') {
                                    addResult('âœ… æµå¼èŠå¤©æµ‹è¯•', `
                                        <strong>çŠ¶æ€:</strong> ${response.status} æµå¼ä¼ è¾“æˆåŠŸ<br>
                                        <strong>å®Œæ•´å›å¤:</strong> ${fullContent}<br>
                                        <strong>è¯´æ˜:</strong> æµå¼APIå·¥ä½œæ­£å¸¸ï¼
                                    `, true);
                                    return;
                                }
                                
                                try {
                                    const parsed = JSON.parse(data);
                                    if (parsed.content) {
                                        fullContent += parsed.content;
                                    }
                                } catch (e) {
                                    // è·³è¿‡æ— æ³•è§£æçš„æ•°æ®
                                }
                            }
                        }
                    }
                } else {
                    addResult('âŒ æµå¼èŠå¤©æµ‹è¯•å¤±è´¥', 'å“åº”ä½“ä¸ºç©º', false);
                }
            } catch (error) {
                addResult('âŒ æµå¼èŠå¤©æµ‹è¯•å¤±è´¥', `é”™è¯¯: ${error.message}`, false);
            }
        }
        
        function openRealChatPage() {
            window.open(`${FRONTEND_URL}/agent`, '_blank');
            addResult('ğŸ“„ æ‰“å¼€çœŸå®èŠå¤©é¡µé¢', `
                å·²åœ¨æ–°çª—å£ä¸­æ‰“å¼€: <a href="${FRONTEND_URL}/agent" target="_blank">${FRONTEND_URL}/agent</a><br>
                <strong>è¯´æ˜:</strong> è¯·åœ¨æ–°çª—å£ä¸­æµ‹è¯•çœŸå®çš„èŠå¤©ç•Œé¢
            `, true);
        }
        
        // è‡ªåŠ¨è¿è¡Œä¸€äº›æµ‹è¯•
        window.addEventListener('load', () => {
            setTimeout(() => {
                console.log('å¼€å§‹è‡ªåŠ¨æµ‹è¯•...');
                testChatDirectly();
                setTimeout(testFrontendProxy, 2000);
            }, 1000);
        });
    </script>
</body>
</html>