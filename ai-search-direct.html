<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIæœç´¢ - ç›´è¿ç‰ˆæœ¬</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.2em;
            margin-bottom: 10px;
        }
        
        .main-content {
            padding: 30px;
        }
        
        .search-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 25px;
        }
        
        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .company-input {
            flex: 1;
            min-width: 250px;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
        }
        
        .search-btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            white-space: nowrap;
        }
        
        .search-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        .options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .option {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .progress-section {
            display: none;
            background: #fff3cd;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin: 15px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            width: 0%;
            transition: width 0.5s;
        }
        
        .error-section {
            display: none;
            background: #f8d7da;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
            color: #721c24;
        }
        
        .results-section {
            display: none;
        }
        
        .report-card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        
        .report-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
        }
        
        .report-content {
            padding: 25px;
            line-height: 1.6;
        }
        
        .example-companies {
            margin-top: 15px;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .example-btn {
            padding: 6px 12px;
            background: #e9ecef;
            border: 1px solid #ced4da;
            border-radius: 15px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }
        
        .example-btn:hover {
            background: #4facfe;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¤– AIæ™ºèƒ½æœç´¢ - ç›´è¿ç‰ˆæœ¬</h1>
            <p>ç›´æ¥è¿æ¥åç«¯APIï¼Œç»•è¿‡ä»£ç†é™åˆ¶</p>
        </div>
        
        <div class="main-content">
            <div class="search-section">
                <div class="input-group">
                    <input type="text" 
                           class="company-input" 
                           id="companyInput" 
                           placeholder="è¾“å…¥å…¬å¸åç§°..."
                           value="Tesla Motors">
                    <button class="search-btn" id="searchBtn" onclick="startAISearch()">
                        ğŸš€ å¼€å§‹AIæœç´¢
                    </button>
                </div>
                
                <div class="options">
                    <div class="option">
                        <input type="checkbox" id="includeFinancial" checked>
                        <label for="includeFinancial">åŒ…å«è´¢åŠ¡ä¿¡æ¯</label>
                    </div>
                    <div class="option">
                        <input type="checkbox" id="includeProducts" checked>
                        <label for="includeProducts">äº§å“/æœåŠ¡åˆ†æ</label>
                    </div>
                    <div class="option">
                        <input type="checkbox" id="includeMarket" checked>
                        <label for="includeMarket">å¸‚åœºåœ°ä½è¯„ä¼°</label>
                    </div>
                    <div class="option">
                        <input type="checkbox" id="includeStrategy" checked>
                        <label for="includeStrategy">å•†åŠ¡ç­–ç•¥å»ºè®®</label>
                    </div>
                </div>
                
                <div class="example-companies">
                    <strong>å¿«é€Ÿæµ‹è¯•:</strong>
                    <button class="example-btn" onclick="fillExample('Apple Inc.')">Apple Inc.</button>
                    <button class="example-btn" onclick="fillExample('Tesla Motors')">Tesla</button>
                    <button class="example-btn" onclick="fillExample('åä¸ºæŠ€æœ¯æœ‰é™å…¬å¸')">åä¸º</button>
                    <button class="example-btn" onclick="fillExample('Microsoft Corporation')">å¾®è½¯</button>
                </div>
            </div>
            
            <div class="progress-section" id="progressSection">
                <h3>ğŸ”„ AIæ­£åœ¨åˆ†æä¸­...</h3>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div id="progressText">å‡†å¤‡å¼€å§‹...</div>
            </div>
            
            <div class="error-section" id="errorSection">
                <h3>âŒ åˆ†æå¤±è´¥</h3>
                <div id="errorMessage"></div>
                <button onclick="retrySearch()" style="margin-top: 10px; padding: 8px 16px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer;">é‡è¯•</button>
            </div>
            
            <div class="results-section" id="resultsSection">
                <div class="report-card">
                    <div class="report-header">
                        <h2 id="reportTitle">ğŸ“Š AIåˆ†ææŠ¥å‘Š</h2>
                        <div id="reportMeta"></div>
                    </div>
                    <div class="report-content" id="reportContent"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ç›´æ¥ä½¿ç”¨åç«¯APIï¼Œé¿å…ä»£ç†é—®é¢˜
        const BACKEND_API_URL = 'https://3001-ibr8pve55krqf22np4xrh-6532622b.e2b.dev';
        
        function fillExample(companyName) {
            document.getElementById('companyInput').value = companyName;
        }
        
        async function startAISearch() {
            const companyName = document.getElementById('companyInput').value.trim();
            if (!companyName) {
                showError('è¯·è¾“å…¥å…¬å¸åç§°');
                return;
            }
            
            const options = {
                includeFinancial: document.getElementById('includeFinancial').checked,
                includeProducts: document.getElementById('includeProducts').checked,
                includeMarket: document.getElementById('includeMarket').checked,
                includeStrategy: document.getElementById('includeStrategy').checked
            };
            
            showProgress();
            hideResults();
            hideError();
            
            const searchBtn = document.getElementById('searchBtn');
            searchBtn.disabled = true;
            searchBtn.textContent = 'ğŸ”„ åˆ†æä¸­...';
            
            try {
                await performAISearch(companyName, options);
            } catch (error) {
                console.error('æœç´¢é”™è¯¯:', error);
                showError(`æœç´¢å¤±è´¥: ${error.message}`);
            } finally {
                searchBtn.disabled = false;
                searchBtn.textContent = 'ğŸš€ å¼€å§‹AIæœç´¢';
                hideProgress();
            }
        }
        
        async function performAISearch(companyName, options) {
            const steps = [
                'ğŸ” åˆå§‹åŒ–AIåˆ†æå¼•æ“...',
                'ğŸ“Š æ”¶é›†å…¬å¸åŸºç¡€ä¿¡æ¯...',
                'ğŸ’¼ åˆ†æä¸šåŠ¡æ¨¡å¼å’Œäº§å“...',
                'ğŸ“ˆ è¯„ä¼°å¸‚åœºè¡¨ç°...',
                'ğŸ’° å¤„ç†è´¢åŠ¡æ•°æ®...',
                'ğŸ“ ç”Ÿæˆç»¼åˆæŠ¥å‘Š...'
            ];
            
            // æ¨¡æ‹Ÿè¿›åº¦æ›´æ–°
            for (let i = 0; i < steps.length; i++) {
                updateProgress((i + 1) / steps.length * 85, steps[i]);
                await sleep(800);
            }
            
            updateProgress(90, 'ğŸ¤– AIæ­£åœ¨æ·±åº¦åˆ†æ...');
            
            // åˆ›å»ºæ§åˆ¶å™¨ç”¨äºè¶…æ—¶å¤„ç†
            const controller = new AbortController();
            const timeoutId = setTimeout(() => {
                controller.abort();
            }, 120000); // 2åˆ†é’Ÿè¶…æ—¶
            
            try {
                const response = await fetch(`${BACKEND_API_URL}/api/ai-search/analyze-company`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        // æ·»åŠ CORSå¤´
                        'Access-Control-Allow-Origin': '*',
                    },
                    mode: 'cors',
                    body: JSON.stringify({
                        companyName: companyName,
                        options: {
                            includeFinancial: options.includeFinancial,
                            includeProducts: options.includeProducts,
                            includeMarket: options.includeMarket,
                            includeStrategy: options.includeStrategy,
                            language: 'zh-CN',
                            depth: 'detailed'
                        }
                    }),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('APIå“åº”é”™è¯¯:', response.status, errorText);
                    throw new Error(`APIè¯·æ±‚å¤±è´¥ (${response.status}): ${errorText.substring(0, 100)}`);
                }
                
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.error || 'AIåˆ†æå¤±è´¥');
                }
                
                updateProgress(100, 'âœ… åˆ†æå®Œæˆï¼');
                await sleep(500);
                showResults(companyName, result.data.report, result.data.usage, result.data.metadata);
                
            } catch (error) {
                clearTimeout(timeoutId);
                if (error.name === 'AbortError') {
                    throw new Error('è¯·æ±‚è¶…æ—¶ï¼Œè¯·å°è¯•é€‰æ‹©æ›´å°‘çš„åˆ†æé€‰é¡¹æˆ–ç¨åé‡è¯•');
                }
                throw error;
            }
        }
        
        function updateProgress(percentage, text) {
            document.getElementById('progressFill').style.width = percentage + '%';
            document.getElementById('progressText').textContent = text;
        }
        
        function showProgress() {
            document.getElementById('progressSection').style.display = 'block';
            updateProgress(0, 'å‡†å¤‡å¼€å§‹...');
        }
        
        function hideProgress() {
            document.getElementById('progressSection').style.display = 'none';
        }
        
        function showResults(companyName, reportContent, usage, metadata) {
            document.getElementById('reportTitle').textContent = `ğŸ“Š ${companyName} - AIæ™ºèƒ½åˆ†ææŠ¥å‘Š`;
            document.getElementById('reportMeta').textContent = `ç”Ÿæˆæ—¶é—´: ${new Date(metadata.generatedAt).toLocaleString('zh-CN')}`;
            
            // æ ¼å¼åŒ–æŠ¥å‘Šå†…å®¹
            const formattedContent = formatMarkdownToHTML(reportContent);
            
            // æ·»åŠ ç»Ÿè®¡ä¿¡æ¯
            const statsInfo = `
                <div style="margin-top: 25px; padding: 15px; background: #f8f9fa; border-radius: 8px; font-size: 14px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                        <div><strong>ğŸ¤– AIæ¨¡å‹:</strong> ${metadata.aiModel}</div>
                        <div><strong>âš¡ å¤„ç†æ—¶é—´:</strong> ${(metadata.processingTimeMs / 1000).toFixed(1)}ç§’</div>
                        <div><strong>ğŸ“Š Tokenæ¶ˆè€—:</strong> ${usage.total_tokens}</div>
                        <div><strong>ğŸ“„ æŠ¥å‘Šé•¿åº¦:</strong> ${reportContent.length}å­—ç¬¦</div>
                    </div>
                    <div style="margin-top: 8px; font-size: 12px; color: #666;">
                        âœ¨ æœ¬æŠ¥å‘Šç”±AIåŸºäºè®­ç»ƒæ•°æ®è‡ªä¸»ç”Ÿæˆï¼Œæ•°æ®æˆªæ­¢è‡³è®­ç»ƒæ—¶é—´
                    </div>
                </div>
            `;
            
            document.getElementById('reportContent').innerHTML = formattedContent + statsInfo;
            document.getElementById('resultsSection').style.display = 'block';
            
            // æ»šåŠ¨åˆ°ç»“æœ
            document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
        }
        
        function hideResults() {
            document.getElementById('resultsSection').style.display = 'none';
        }
        
        function showError(message) {
            const fullMessage = `${message}

ğŸ”§ æŠ€æœ¯è¯¦æƒ…:
- ç›´è¿API: ${BACKEND_API_URL}/api/ai-search/analyze-company
- æ—¶é—´: ${new Date().toLocaleString('zh-CN')}
- æµè§ˆå™¨: ${navigator.userAgent.split(' ').slice(-1)[0]}

ğŸ’¡ è§£å†³å»ºè®®:
1. ç¡®ä¿ç½‘ç»œè¿æ¥æ­£å¸¸
2. å°è¯•åˆ·æ–°é¡µé¢
3. é€‰æ‹©è¾ƒå°‘çš„åˆ†æé€‰é¡¹
4. å°è¯•å…¶ä»–å…¬å¸åç§°`;
            
            document.getElementById('errorMessage').textContent = fullMessage;
            document.getElementById('errorSection').style.display = 'block';
        }
        
        function hideError() {
            document.getElementById('errorSection').style.display = 'none';
        }
        
        function retrySearch() {
            hideError();
            startAISearch();
        }
        
        function formatMarkdownToHTML(markdown) {
            return markdown
                .replace(/^### (.*$)/gm, '<h3 style="color: #2c3e50; margin: 20px 0 10px 0; border-bottom: 1px solid #eee; padding-bottom: 5px;">$1</h3>')
                .replace(/^## (.*$)/gm, '<h2 style="color: #2c3e50; margin: 25px 0 15px 0; border-bottom: 2px solid #3498db; padding-bottom: 8px;">$1</h2>')
                .replace(/^# (.*$)/gm, '<h1 style="color: #2c3e50; margin: 30px 0 20px 0;">$1</h1>')
                .replace(/^\- (.*$)/gm, '<li style="margin: 5px 0;">$1</li>')
                .replace(/\*\*(.*?)\*\*/g, '<strong style="color: #2c3e50;">$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/\n\n/g, '</p><p>')
                .replace(/^(.*)$/gm, '<p>$1</p>')
                .replace(/<p><\/p>/g, '')
                .replace(/<p>(<h[1-6].*?<\/h[1-6]>)<\/p>/g, '$1')
                .replace(/<p>(<li.*?<\/li>)<\/p>/g, '$1')
                .replace(/(<li.*?<\/li>)\s*(<li.*?<\/li>)/gs, function(match) {
                    return '<ul>' + match.replace(/<\/?p>/g, '') + '</ul>';
                });
        }
        
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        
        // å›è½¦é”®æœç´¢
        document.getElementById('companyInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                startAISearch();
            }
        });
        
        // é¡µé¢åŠ è½½å®Œæˆæç¤º
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ¤– AIæ™ºèƒ½æœç´¢ - ç›´è¿ç‰ˆæœ¬å·²å°±ç»ª');
        });
    </script>
</body>
</html>